# On Apline, you will need the following packages:
# apk --update add curl libarchive-tools sudo
OUT_ZIP=k8wsl.zip
LNCR_EXE=k8wsl.exe

DLR=curl
DLR_FLAGS=-L
BASE_URL=https://dl-cdn.alpinelinux.org/alpine/v3.15/releases/x86_64/alpine-minirootfs-3.15.0-x86_64.tar.gz
LNCR_ZIP_URL=https://github.com/yuk7/wsldl/releases/download/21082800/icons.zip
LNCR_ZIP_EXE=Alpine.exe

KUBERNETES_CONTAINER_IMAGES=k8s.gcr.io/pause:3.5 \
	k8s.gcr.io/kube-controller-manager:v1.22.4 \
	k8s.gcr.io/etcd:3.5.0-0 \
	k8s.gcr.io/kube-proxy:v1.22.4 \
	k8s.gcr.io/kube-scheduler:v1.22.4 \
	k8s.gcr.io/coredns/coredns:v1.8.4 \
	k8s.gcr.io/kube-apiserver:v1.22.4


BASE_CONTAINER_IMAGES=docker.io/rancher/local-path-provisioner:v0.0.20 \
	docker.io/rancher/mirrored-flannelcni-flannel-cni-plugin:v1.0.0 \
	quay.io/coreos/flannel:v0.15.1 \
	quay.io/metallb/controller:v0.11.0 \
	quay.io/metallb/speaker:v0.11.0 \
	k8s.gcr.io/metrics-server/metrics-server:v0.5.2

CONTAINER_IMAGES=$(KUBERNETES_CONTAINER_IMAGES) $(BASE_CONTAINER_IMAGES)

all: $(OUT_ZIP)

zip: $(OUT_ZIP)
$(OUT_ZIP): ziproot
	@echo -e '\e[1;31mBuilding $(OUT_ZIP)\e[m'
	cd ziproot; bsdtar -a -cf ../$(OUT_ZIP) *

ziproot: Launcher.exe rootfs.tar.gz
	@echo -e '\e[1;31mBuilding ziproot...\e[m'
	mkdir ziproot
	cp Launcher.exe ziproot/${LNCR_EXE}
	cp rootfs.tar.gz ziproot/

exe: Launcher.exe
Launcher.exe: icons.zip
	@echo -e '\e[1;31mExtracting Launcher.exe...\e[m'
	bsdtar -xvf icons.zip $(LNCR_ZIP_EXE)
	mv $(LNCR_ZIP_EXE) Launcher.exe

icons.zip:
	@echo -e '\e[1;31mDownloading icons.zip...\e[m'
	$(DLR) $(DLR_FLAGS) $(LNCR_ZIP_URL) -o icons.zip

rootfs.tar.gz: rootfs
	@echo -e '\e[1;31mBuilding rootfs.tar.gz...\e[m'
	cd rootfs; sudo tar -zcpf ../rootfs.tar.gz `sudo ls`
	sudo chown `id -un` rootfs.tar.gz

rootfs: base.tar.gz profile
	@echo -e '\e[1;31mBuilding rootfs...\e[m'
	mkdir rootfs
	sudo tar -zxpf base.tar.gz -C rootfs
	sudo cp -f /etc/resolv.conf rootfs/etc/resolv.conf
	sudo cp -f profile rootfs/etc/profile
	sudo cp -f ../k8wsl rootfs
	sudo echo "http://dl-cdn.alpinelinux.org/alpine/edge/testing/" >> rootfs/etc/apk/repositories
	sudo chroot rootfs /sbin/apk --update add zsh oh-my-zsh cri-o kubelet kubeadm kubectl kubelet-openrc cri-o-contrib-cni util-linux-misc
	sudo mv rootfs/etc/cni/net.d/10-crio-bridge.conf rootfs/etc/cni/net.d/12-crio-bridge.conf
	sudo cp -f rootfs/usr/share/oh-my-zsh/templates/zshrc.zsh-template rootfs/root/.zshrc
	sudo chmod +x rootfs/root/.zshrc
	sudo sed -ie '/^root:/ s#:/bin/.*$$#:/bin/zsh#' rootfs/etc/passwd
	echo "# This file was automatically generated by WSL. To stop automatic generation of this file, remove this line." | sudo tee rootfs/etc/resolv.conf
	sudo rm -rf `sudo find rootfs/var/cache/apk/ -type f`
	sudo mkdir -p rootfs/var/lib/containers/storage
	sudo mount -o rbind rootfs/var/lib/containers/storage /var/lib/containers/storage
	$(foreach I, $(IMAGES), skopeo copy docker://$I containers-storage:$I;)
	sudo umount /var/lib/containers/storage/overlay
	sudo umount /var/lib/containers/storage
	sudo chmod +x rootfs

# For this to work, you need to have cri-o and skopeo installed locally
.PHONY:
make_images:
	sudo mount -o rbind rootfs/var/lib/containers/storage /var/lib/containers/storage
	$(foreach I, $(CONTAINER_IMAGES), skopeo copy docker://$I containers-storage:$I;)
	sudo umount /var/lib/containers/storage/overlay
	sudo umount /var/lib/containers/storage

images: images.tar.gz
	@echo -e '\e[1;31mUncompressing images...\e[m'
	bsdtar -zxvf images.tar.gz

base.tar.gz:
	@echo -e '\e[1;31mDownloading base.tar.gz...\e[m'
	$(DLR) $(DLR_FLAGS) $(BASE_URL) -o base.tar.gz

clean:
	@echo -e '\e[1;31mCleaning files...\e[m'
	-rm ${OUT_ZIP}
	-rm -r ziproot
	-rm Launcher.exe
	-rm icons.zip
	-rm rootfs.tar.gz
	-sudo rm -r rootfs
	-rm base.tar.gz
